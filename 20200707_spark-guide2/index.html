<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Spark Guide, Part Ⅱ - JerrysBlog</title><meta name=Description content="Article description."><meta property="og:title" content="Spark Guide, Part Ⅱ"><meta property="og:description" content="Article description."><meta property="og:type" content="article"><meta property="og:url" content="https://jerrysmd.github.io/20200707_spark-guide2/"><meta property="og:image" content="https://jerrysmd.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-07-07T11:14:54+08:00"><meta property="article:modified_time" content="2020-07-07T11:14:54+08:00"><meta property="og:site_name" content="JerrysBlog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jerrysmd.github.io/logo.png"><meta name=twitter:title content="Spark Guide, Part Ⅱ"><meta name=twitter:description content="Article description."><meta name=application-name content="JerrysBlog"><meta name=apple-mobile-web-app-title content="JerrysBlog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://jerrysmd.github.io/20200707_spark-guide2/><link rel=prev href=https://jerrysmd.github.io/20200615_hive-key-point/><link rel=next href=https://jerrysmd.github.io/20200803_spark-guide3/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Spark Guide, Part Ⅱ","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/jerrysmd.github.io\/20200707_spark-guide2\/"},"image":[{"@type":"ImageObject","url":"https:\/\/jerrysmd.github.io\/images\/Apple-Devices-Preview.png","width":3200,"height":2048}],"genre":"posts","keywords":"Distribution, Spark","wordcount":2068,"url":"https:\/\/jerrysmd.github.io\/20200707_spark-guide2\/","datePublished":"2020-07-07T11:14:54+08:00","dateModified":"2020-07-07T11:14:54+08:00","publisher":{"@type":"Organization","name":"xxxx","logo":{"@type":"ImageObject","url":"https:\/\/jerrysmd.github.io\/images\/avatar.png","width":528,"height":560}},"author":{"@type":"Person","name":" "},"description":"Article description."}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=JerrysBlog><span id=id-1 class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/>Home </a><a class=menu-item href=/categories/technology/>Technology </a><a class=menu-item href=/categories/life/>Life </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/about/>About </a><a class=menu-item href=https://github.com/Jerrysmd title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=JerrysBlog><span id=id-2 class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/ title>Home</a><a class=menu-item href=/categories/technology/ title>Technology</a><a class=menu-item href=/categories/life/ title>Life</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=https://github.com/Jerrysmd title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Spark Guide, Part Ⅱ</h1><div class=post-meta><div class=post-meta-line><span class=post-category>Category in
<a href=/categories/technology/><i class="far fa-folder fa-fw" aria-hidden=true></i>Technology</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2020-07-07>2020-07-07</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2068 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;10 minutes&nbsp;<span id=/20200707_spark-guide2/ class=leancloud_visitors data-flag-title="Spark Guide, Part Ⅱ">
<i class="far fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;views
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#advanced-operation>Advanced Operation</a></li><li><a href=#sparksql>SparkSQL</a></li><li><a href=#data-type-transformation>Data Type Transformation</a></li><li><a href=#data-typeless-transformation>Data Typeless Transformation</a></li><li><a href=#column>Column</a></li><li><a href=#na>N/A</a></li><li><a href=#groupby>groupBy</a></li><li><a href=#table-join>Table Join</a></li><li><a href=#udf>UDF</a></li><li><a href=#over-rank>Over Rank</a></li></ul></nav></div></div><div class=content id=content><p>Apache Spark has its architectural foundation in the resilient distributed dataset (RDD), a read-only multiset of data items distributed over a cluster of machines, that is maintained in a fault-tolerant way. The Dataframe API was released as an abstraction on top of the RDD, followed by the Dataset API.</p><h2 id=advanced-operation>Advanced Operation</h2><p>closure</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>test</span><span class=o>()</span><span class=k>:</span> <span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=n>f</span> <span class=k>=</span> <span class=n>closure</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>(</span><span class=mi>5</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=n>closure</span><span class=o>()</span><span class=k>:</span> <span class=kt>Int</span> <span class=o>=&gt;</span> <span class=nc>Double</span> <span class=k>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=n>factor</span> <span class=k>=</span> <span class=mf>3.14</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=n>areaFunction</span> <span class=k>=</span> <span class=o>(</span><span class=n>r</span><span class=k>:</span> <span class=kt>int</span><span class=o>)</span> <span class=k>=&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>math</span><span class=o>.</span><span class=n>pow</span><span class=o>(</span><span class=n>r</span><span class=o>,</span><span class=mi>2</span><span class=o>)</span> <span class=o>*</span> <span class=n>factor</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=n>areaFunction</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><ol><li>f就是闭包，闭包的本质就是一个函数</li><li>在scala中函数是一个特殊的类型，FunctionX</li><li>闭包也是一个FunctionX类型的对象</li><li>闭包是一个对象</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>class</span> <span class=nc>MyClass</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=n>field</span> <span class=k>=</span> <span class=s>&#34;Hello&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=n>doStuff</span><span class=o>(</span><span class=n>rdd</span><span class=k>:</span> <span class=kt>RDD</span><span class=o>[</span><span class=kt>String</span><span class=o>])</span><span class=k>:</span> <span class=kt>RDD</span> <span class=o>[</span><span class=kt>String</span><span class=o>]</span> <span class=k>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>rdd</span><span class=o>.</span><span class=n>map</span><span class=o>(</span><span class=n>x</span> <span class=k>=&gt;</span> <span class=n>field</span> <span class=o>+</span> <span class=n>x</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>//引用Myclass对象中的一个成员变量，说明其可以访问MyClass这个类的总用域，也是一个闭包。封闭的是MyClass这个作用域。
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//在将其分发的不同的Executor中执行的时候，其依赖MyClass这个类当前的对象，因为其封闭了这个作用域。MyClass和函数都要一起被序列化。发到不同的结点中执行。
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//1. 如果MyClass不能被序列化，将会报错
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//2. 如果在这个闭包中，依赖了一个外部很大的集合，那么这个集合会随着每一个Task分发
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Global accumulator</p><ol><li><p>在任意地方创建long accumulator</p></li><li><p>累加</p></li><li><p>结果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>val</span> <span class=n>counter</span> <span class=k>=</span> <span class=n>sc</span><span class=o>.</span><span class=n>longAccumulator</span><span class=o>(</span><span class=s>&#34;counter&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>result</span> <span class=k>=</span> <span class=n>sc</span><span class=o>.</span><span class=n>parallelize</span><span class=o>(</span><span class=nc>Seq</span><span class=o>(</span><span class=mi>1</span><span class=o>,</span><span class=mi>2</span><span class=o>,</span><span class=mi>3</span><span class=o>,</span><span class=mi>4</span><span class=o>,</span><span class=mi>5</span><span class=o>)).</span><span class=n>foreach</span><span class=o>(</span><span class=n>counter</span><span class=o>.</span><span class=n>add</span><span class=o>(</span><span class=k>_</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=n>counter</span><span class=o>.</span><span class=n>value</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><p>Broadcast</p><p>广播变量允许将一个Read-Only的变量缓存到集群中的每个节点上，而不是传递给每一个Task一个副本</p><ul><li>集群中的每个节点指的是一个机器</li><li>每一个Task，一个Task是一个Stage中的最小处理单元，一个Executor中可以有多个Stage，每个Stage有多个Task</li></ul><p>所以在需要多个Stage的多个Task中使用相同数据的情况下，广播特别有用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>val</span> <span class=n>v</span> <span class=k>=</span> <span class=nc>Map</span><span class=o>(</span><span class=s>&#34;Spark&#34;</span> <span class=o>-&gt;</span> <span class=s>&#34;http[123]&#34;</span><span class=o>,</span> <span class=s>&#34;scala&#34;</span> <span class=o>-&gt;</span> <span class=s>&#34;http[456]&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>config</span> <span class=k>=</span> <span class=k>new</span> <span class=nc>SparkConf</span><span class=o>().</span><span class=n>setMaster</span><span class=o>(</span><span class=s>&#34;local[6]&#34;</span><span class=o>).</span><span class=n>setAppName</span><span class=o>(</span><span class=s>&#34;bc&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>sc</span> <span class=k>=</span> <span class=k>new</span> <span class=nc>SparkContext</span><span class=o>(</span><span class=n>config</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//创建广播
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>val</span> <span class=n>bc</span> <span class=k>=</span> <span class=n>sc</span><span class=o>.</span><span class=n>broadcast</span><span class=o>(</span><span class=n>v</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>r</span> <span class=k>=</span> <span class=n>sc</span><span class=o>.</span><span class=n>parallelize</span><span class=o>(</span><span class=nc>Seq</span><span class=o>(</span><span class=s>&#34;Spark&#34;</span><span class=o>,</span> <span class=s>&#34;Scala&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//使用广播变量代替直接引用集合，只会复制和executor一样的数量
</span></span></span><span class=line><span class=cl><span class=c1>//在使用广播之前，复制map了task数量份
</span></span></span><span class=line><span class=cl><span class=c1>//在使用广播之后，复制次数和executor数量一致
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>val</span> <span class=n>result</span> <span class=k>=</span> <span class=n>r</span><span class=o>.</span><span class=n>map</span><span class=o>(</span><span class=n>item</span> <span class=k>=&gt;</span> <span class=n>bc</span><span class=o>.</span><span class=n>value</span><span class=o>(</span><span class=n>item</span><span class=o>)).</span><span class=n>collect</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=sparksql>SparkSQL</h2><ul><li>Spark的RDD主要用于处理非结构化数据和半结构化数据</li><li>SparkSQL主要用于处理结构化数据</li><li>SparkSQL支持：命令式、SQL</li></ul><p>优势：</p><ul><li>虽然SparkSQL是基于RDD的，但是SparkSQL的速度比RDD要快很多</li><li>SparkSQL提供了更好的外部数据源读写支持</li><li>SparkSQL提供了直接访问列的能力</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>case</span> <span class=k>class</span> <span class=nc>Person</span><span class=o>(</span><span class=n>name</span><span class=k>:</span> <span class=kt>String</span><span class=o>,</span> <span class=n>age</span><span class=k>:</span> <span class=kt>Int</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>spark</span><span class=k>:</span> <span class=kt>SparkSession</span> <span class=o>=</span> <span class=k>new</span> <span class=n>sql</span><span class=o>.</span><span class=nc>SparkSession</span><span class=o>.</span><span class=nc>Builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>appName</span><span class=o>(</span><span class=s>&#34;hello&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>master</span><span class=o>(</span><span class=s>&#34;local[6]&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>getOrCreate</span><span class=o>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>impart</span> <span class=n>spark</span><span class=o>.</span><span class=n>implicits</span><span class=o>.</span><span class=k>_</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>personRDD</span><span class=k>:</span> <span class=kt>RDD</span><span class=o>[</span><span class=kt>people</span><span class=o>]</span> <span class=k>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>sparkContext</span><span class=o>.</span><span class=n>parallelize</span><span class=o>(</span><span class=nc>Seq</span><span class=o>(</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span> <span class=mi>10</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;ls&#34;</span><span class=o>,</span> <span class=mi>15</span><span class=o>)))</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>personDS</span><span class=k>:</span> <span class=kt>Dataset</span><span class=o>[</span><span class=kt>Person</span><span class=o>]</span> <span class=k>=</span> <span class=nc>PersonRDD</span><span class=o>.</span><span class=n>toDS</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>teenagers</span><span class=k>:</span> <span class=kt>Dataset</span><span class=o>[</span><span class=kt>String</span><span class=o>]</span> <span class=k>=</span> <span class=nc>PersonDS</span><span class=o>.</span><span class=n>where</span><span class=o>(</span>&#39;age <span class=o>&gt;</span> <span class=mi>10</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>where</span><span class=o>(</span>&#39;age <span class=o>&lt;</span> <span class=mi>20</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>select</span><span class=o>(</span>&#39;name<span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>as</span><span class=o>[</span><span class=kt>String</span><span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>RDD和SparkSQL运行时的区别</strong></p><ul><li><p>RDD的运行流程：</p><p>RDD->DAGScheduler->TaskScheduleri->Worker</p><p>先将RDD解析为由Stage组成的DAG，后将Stage转为Task直接运行</p></li><li><p>SparkSQL的运行流程：</p><ol><li>解析SQL，并且生成AST（抽象语法树）</li><li>在AST中加入元数据信息，做这一步主要是为了一些优化，例如 col = col 这样的条件</li><li>对已经加入元数据的AST，输入优化器，进行优化（例如：谓词下推，列值裁剪）</li><li>生成的AST其实最终还没办法直接运行，这个AST是逻辑计划，结束后，需要生成物理计划，从而生成RDD来运行。</li></ol></li></ul><p>Dataset & DataFrame</p><p><strong>RDD 优点：</strong></p><ol><li><p>JVM对象组成的分布式数据集合</p></li><li><p>不可变并且有容错能力</p></li><li><p>可处理机构化和非结构化的数据</p></li><li><p>支持函数式转换</p></li></ol><p><strong>RDD缺点：</strong></p><ol><li>没有Schema</li><li>用户自己优化程序</li><li>从不同的数据源读取数据非常困难</li><li>合并多个数据源中的数据也非常困难</li></ol><p><strong>DataFrame:</strong></p><ol><li>DataFrame类似一张关系型数据的表</li><li>在DataFrame上的操作，非常类似SQL语句</li><li>DataFrame中有行和列，Schema</li></ol><p><strong>DataFrame的优点：</strong></p><ol><li><p>Row对象组成的分布式数据集</p></li><li><p>不可变并且有容错能力</p></li><li><p>处理结构化数据</p></li><li><p>自带优化器Catalyset,可自动优化程序</p></li><li><p>Data source API</p></li><li><p>DataFrame让Spark对结构化数据有了处理能力</p></li></ol><p><strong>DataFrame的缺点：</strong></p><ol><li>编译时不能类型转化安全检查，运行时才能确定是否有问题</li><li>对于对象支持不友好，rdd内部数据直接以java对象存储，dataframe内存存储的是row对象而不能是自定义对象</li></ol><p><strong>Dataset的优点：</strong></p><ol><li>DateSet整合了RDD和DataFrame的优点，支持结构化和非结构化数据</li><li>和RDD一样，支持自定义对象存储</li><li>和DataFrame一样，支持结构化数据的sql查询</li><li>采用堆外内存存储，gc友好</li><li>类型转化安全，代码友好</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>dataset1</span><span class=o>()</span><span class=k>:</span> <span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//1.创建SparkSession
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>val</span> <span class=n>spark</span> <span class=k>=</span> <span class=k>new</span> <span class=n>sql</span><span class=o>.</span><span class=nc>SparkSession</span><span class=o>.</span><span class=nc>Builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>master</span><span class=o>(</span><span class=s>&#34;local[6]&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>appName</span><span class=o>(</span><span class=s>&#34;dateset1&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>getOrCreate</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>//2.导入隐式转化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>import</span> <span class=nn>spark.implicits._</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>//3.demo
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>val</span> <span class=n>sourceRDD</span> <span class=k>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>sparkContext</span><span class=o>.</span><span class=n>parallelize</span><span class=o>(</span><span class=nc>Seq</span><span class=o>(</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span> <span class=mi>10</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;ls&#34;</span><span class=o>,</span> <span class=mi>15</span><span class=o>)))</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=n>dataset</span> <span class=k>=</span> <span class=n>sourceRDD</span><span class=o>.</span><span class=n>toDS</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>//Dataset支持强类型API
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>dataset</span><span class=o>.</span><span class=n>filter</span><span class=o>(</span><span class=n>item</span> <span class=k>=&gt;</span> <span class=n>item</span><span class=o>.</span><span class=n>age</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>//Dataset支持弱类型API
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>dataset</span><span class=o>.</span><span class=n>filter</span><span class=o>(</span> &#39;age <span class=o>&gt;</span> <span class=mi>10</span> <span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset</span><span class=o>.</span><span class=n>filter</span><span class=o>(</span> <span class=n>$</span><span class=s>&#34;age&#34;</span> <span class=o>&gt;</span> <span class=mi>10</span> <span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>//Dataset可以直接编写SQL表达式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>dataset</span><span class=o>.</span><span class=n>filter</span><span class=o>(</span> <span class=s>&#34;age &gt; 10&#34;</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>DataFrame Practice:</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>dataframe1</span><span class=o>()</span><span class=k>:</span> <span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//1. 创建SparkSession
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>val</span> <span class=n>spark</span> <span class=k>=</span> <span class=nc>SparkSession</span><span class=o>.</span><span class=n>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>master</span><span class=o>(</span><span class=s>&#34;local[6]&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>appName</span><span class=o>(</span><span class=s>&#34;pm analysis&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>getOrCreate</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>//2.读取数据集
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>val</span> <span class=n>souceDF</span> <span class=k>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>read</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>option</span><span class=o>(</span><span class=s>&#34;header&#34;</span><span class=o>,</span> <span class=n>value</span> <span class=k>=</span> <span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>csv</span><span class=o>(</span><span class=s>&#34;dataset/beijingPM.csv&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>//3.处理数据集
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>sourceDF</span><span class=o>.</span><span class=n>select</span><span class=o>(</span>&#39;year<span class=o>,</span> &#39;month<span class=o>,</span> &#39;PM_Dongsi<span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>where</span><span class=o>(</span>&#39;PM_Dongsi <span class=o>=!=</span> <span class=s>&#34;NA&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>groupBy</span><span class=o>(</span>&#39;year<span class=o>,</span> &#39;month<span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>count</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>spark</span><span class=o>.</span><span class=n>stop</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>DataFrame & Dataset 区别：</p><ol><li><p>DataFrame是Dataset的一种特殊情况，DataFrame是Dataset[Row]的别名</p></li><li><p><strong>DataFrame表达的含义是一个支持函数式操作的表，而Dataset表达是一个类似RDD的东西，Dataset可以处理任何对象</strong></p></li><li><p><strong>DataFrame中存放的是Row对象，而Dataset中可以存放任何类型的对象</strong></p></li><li><p>DataFrame是弱类型，Dataset是强类型。DataFrame的操作方式和Dataset是一样的，但是对于强类型的操作而言，他们处理的类型是不同的</p><p>DataFrame在进行强类型操作的时候，例如map算子，所处理的数据类型永远是Row</p><p>而Dataset，其中是什么类型，他就处理什么类型。</p></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>val</span> <span class=n>df</span><span class=k>:</span> <span class=kt>DataFrame</span> <span class=o>=</span> <span class=n>personList</span><span class=o>.</span><span class=n>toDF</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>map</span><span class=o>(</span> <span class=o>(</span><span class=n>row</span><span class=k>:</span> <span class=kt>Row</span><span class=o>)</span> <span class=k>=&gt;</span> <span class=nc>Row</span><span class=o>(</span><span class=n>row</span><span class=o>.</span><span class=n>get</span><span class=o>(</span><span class=mi>0</span><span class=o>),</span> <span class=n>row</span><span class=o>,</span><span class=n>getAs</span><span class=o>[</span><span class=kt>Int</span><span class=o>](</span><span class=mi>1</span><span class=o>)</span> <span class=o>*</span> <span class=mi>2</span><span class=o>))(</span><span class=nc>RowEncoder</span><span class=o>.</span><span class=n>apply</span><span class=o>(</span><span class=n>df</span><span class=o>.</span><span class=n>schema</span><span class=o>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>ds</span><span class=k>:</span> <span class=kt>Dataset</span><span class=o>[</span><span class=kt>person</span><span class=o>]</span> <span class=k>=</span> <span class=n>personList</span><span class=o>.</span><span class=n>toDS</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=n>map</span><span class=o>((</span><span class=n>person</span><span class=k>:</span> <span class=kt>Person</span> <span class=o>=&gt;</span> <span class=nc>Person</span><span class=o>(</span><span class=n>person</span><span class=o>.</span><span class=n>name</span><span class=o>,</span> <span class=n>person</span><span class=o>.</span><span class=n>age</span> <span class=o>*</span> <span class=mi>2</span><span class=o>)))</span>
</span></span></code></pre></td></tr></table></div></div><ol start=5><li><p>DataFrame只能做到运行时类型检查，Dataset能做到编译和运行都有类型检查</p><p>DataFrame弱类型是编译时不安全(df.groupBy(&ldquo;name, school&rdquo;))</p><p>Dataset所代表的操作，是类型安全的，编译时安全的(ds.filter(person => person.name))</p></li></ol><p>Row</p><p>DataFrame就是Row集合加上Schema信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>case</span> <span class=k>class</span> <span class=nc>Person</span><span class=o>(</span><span class=n>name</span><span class=k>:</span> <span class=kt>String</span><span class=o>,</span> <span class=n>age</span><span class=k>:</span> <span class=kt>Int</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=n>row</span><span class=o>()</span><span class=k>:</span> <span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//1.Row如何创建，是什么
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//row对象必须配合Schema对象才会有列名
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>val</span> <span class=n>person</span> <span class=k>=</span> <span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span> <span class=mi>15</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=n>row</span> <span class=k>=</span> <span class=nc>Row</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span> <span class=mi>15</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>//2.如何从Row中获取数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>row</span><span class=o>.</span><span class=n>getString</span><span class=o>(</span><span class=mi>0</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>row</span><span class=o>.</span><span class=n>getInt</span><span class=o>(</span><span class=mi>1</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>//3.Row也是样例类
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>row</span> <span class=k>match</span><span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nc>Row</span><span class=o>(</span><span class=n>name</span><span class=o>,</span> <span class=n>age</span><span class=o>)</span> <span class=k>=&gt;</span> <span class=n>println</span><span class=o>(</span><span class=n>name</span><span class=o>,</span> <span class=n>age</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Reader</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>reader1</span><span class=o>()</span><span class=k>:</span> <span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//1.create SparkSession
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>val</span> <span class=n>spark</span> <span class=k>=</span> <span class=nc>SparkSession</span><span class=o>.</span><span class=n>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>master</span><span class=o>(</span><span class=s>&#34;local[6]&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>appName</span><span class=o>(</span><span class=s>&#34;reader1&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>getOrCreate</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>   <span class=c1>//2.firstWay
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>spark</span><span class=o>.</span><span class=n>read</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>format</span><span class=o>(</span><span class=s>&#34;csv&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>option</span><span class=o>(</span><span class=s>&#34;header&#34;</span><span class=o>,</span> <span class=n>value</span> <span class=k>=</span> <span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>option</span><span class=o>(</span><span class=s>&#34;inferSchema&#34;</span><span class=o>,</span> <span class=n>value</span> <span class=k>=</span> <span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>load</span><span class=o>(</span><span class=s>&#34;dataset/bjPM.csv&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>show</span><span class=o>(</span><span class=mi>10</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>//3.sencendWay
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>spark</span><span class=o>.</span><span class=n>read</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>option</span><span class=o>(</span><span class=s>&#34;header&#34;</span><span class=o>,</span> <span class=n>value</span> <span class=k>=</span> <span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>option</span><span class=o>(</span><span class=s>&#34;inferSchema&#34;</span><span class=o>,</span> <span class=n>value</span> <span class=k>=</span> <span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>csv</span><span class=o>(</span><span class=s>&#34;dataset/bjPM.csv&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>show</span><span class=o>(</span><span class=mi>10</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Writer</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>writer1</span><span class=o>()</span><span class=k>:</span> <span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nc>System</span><span class=o>.</span><span class=n>setProperty</span><span class=o>(</span><span class=s>&#34;hodoop.home.dir&#34;</span><span class=o>,</span><span class=s>&#34;c:\\winutils&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>//1.create SparkSession
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>val</span> <span class=n>spark</span> <span class=k>=</span> <span class=nc>SparkSession</span><span class=o>.</span><span class=n>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>master</span><span class=o>(</span><span class=s>&#34;local[6]&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>appName</span><span class=o>(</span><span class=s>&#34;reader1&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>getOrCreate</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>//2.read data
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>val</span> <span class=n>df</span> <span class=k>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>read</span><span class=o>.</span><span class=n>option</span><span class=o>(</span><span class=s>&#34;header&#34;</span><span class=o>,</span> <span class=kc>true</span><span class=o>).</span><span class=n>csv</span><span class=o>(</span><span class=s>&#34;dataset/bjPM.csv&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>//3.writer
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>df</span><span class=o>.</span><span class=n>write</span><span class=o>.</span><span class=n>json</span><span class=o>(</span><span class=s>&#34;dataset/bjPM.json&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=o>.</span><span class=n>write</span><span class=o>.</span><span class=n>format</span><span class=o>(</span><span class=s>&#34;json&#34;</span><span class=o>).</span><span class=n>save</span><span class=o>(</span><span class=s>&#34;dataset/bjPM2.json&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Parquet</p><p>Parquet属于Hadoop生态圈的一种<strong>新型列式存储</strong>格式，既然属于Hadoop生态圈，因此也兼容大多圈内计算框架（Hadoop、Spark），另外Parquet是平台、语言无关的，这使得它的适用性很广，只要相关语言有对应支持的类库就可以用；</p><p>Parquet的优劣对比：</p><ul><li>支持嵌套结构，这点对比同样是列式存储的OCR具备一定优势；</li><li>适用于OLAP场景，对比CSV等行式存储结构，列示存储支持<strong>映射下推</strong>和<strong>谓词下推</strong>，减少磁盘IO；</li><li>同样的压缩方式下，列式存储因为每一列都是同构的，因此可以使用更高效的压缩方法；</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>parquet</span><span class=o>()</span><span class=k>:</span> <span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//read
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>val</span> <span class=n>df</span> <span class=k>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>read</span><span class=o>.</span><span class=n>option</span><span class=o>(</span><span class=s>&#34;header&#34;</span><span class=o>,</span> <span class=kc>true</span><span class=o>).</span><span class=n>csv</span><span class=o>(</span><span class=s>&#34;dataset/bjPM.csv&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>//把数据写为parquet格式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>df</span><span class=o>.</span><span class=n>write</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>format</span><span class=o>(</span><span class=s>&#34;parquet&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>mode</span><span class=o>(</span><span class=nc>Savemode</span><span class=o>.</span><span class=nc>Overwrite</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>save</span><span class=o>(</span><span class=s>&#34;dataset/bj_PM&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>//读取Parquet格式文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>spark</span><span class=o>.</span><span class=n>read</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>load</span><span class=o>(</span><span class=s>&#34;dataset/bj_PM&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Partition</p><p>表分区的概念不仅在parquet上有，其他格式的文件也可以指定表分区</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>parquetPartions</span><span class=o>()</span><span class=k>:</span> <span class=kt>Unit</span> <span class=o>={</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=n>df</span> <span class=k>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>read</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>option</span><span class=o>(</span><span class=s>&#34;header&#34;</span><span class=o>,</span><span class=n>value</span> <span class=k>=</span> <span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>csv</span><span class=o>(</span><span class=s>&#34;dataset/BJPM.csv&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>//分区表形式写文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>df</span><span class=o>.</span><span class=n>write</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>partitionBy</span><span class=o>(</span><span class=s>&#34;year&#34;</span><span class=o>,</span> <span class=s>&#34;month&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>save</span><span class=o>(</span><span class=n>dataset</span><span class=o>/</span><span class=n>bjPM4</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>//读文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//写分区的时候，分区列不会包含在生成的文件中
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//直接通过文件来进行读取的话，分区信息会丢失
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//spark SQL自动发现分区
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>spark</span><span class=o>.</span><span class=n>read</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>parquet</span><span class=o>(</span><span class=s>&#34;dataset/bjPM4&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>printSchema</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>JSON</p><ul><li>toJSON: 把Dataset[Object]转为Dataset[JsonString]</li><li>可以直接从RDD读取JSON的DataFrame，把RDD[JsonString]转为Dataset[Object]</li></ul><p>Hive</p><p>整合什么内容</p><blockquote><ul><li><p>MetaStore，元数据存储</p><p>SparkSql内置的有一个MetaStore。更成熟，功能更强，而且可以使用Hive的元信息</p></li><li><p>查询引擎</p><p>SparkSQL内置了HiveSQL的支持</p></li></ul></blockquote><p>Hive的MetaStore</p><blockquote><p>Hive的MetaStore是Hive的一个组件。Hive中主要的组件组件就三个：</p><ol><li>HiveServer2负责接收外部系统的查询请求，列如JDBC，HiveServer2接收查询请求后，交给Driver处理</li><li>Driver会首先询问MetaStore表在哪存，后Driver程序通过MR程序来访问HDFS从而获取结果返回给查询请求者</li><li>MetaStore对SparkSQL的意义重大，如果SparkSQL可以直接访问Hive的MetaStore，则理论上可以做和Hive一样的事情，例如通过Hive表查询数据</li></ol><p>而Hive的MetaStore的运行模式有三种：</p><ul><li><p>内嵌Derby数据库模式</p><p>单链接，不支持并发</p></li><li><p>local模式</p><p>local和remote都是访问MySQL数据库作为存储元数据的地方，但是local模式的MetaStore没有独立进程，依附于HiveServer2的进程</p></li><li><p>Remote模式</p><p>和Local模式一样，访问MySQL数据库存放元数据，但是Remote的MetaStore运行在独立的进程中</p></li></ul></blockquote><p>Hive开启MetaStore</p><blockquote><ol><li><p>修改hive-sito.xml</p></li><li><p>启动Hive MetaStore</p><p>nohup /export/servers/hive/bin/hive &ndash;service metastore 2>&1 &#187; /var/log.log &</p></li></ol></blockquote><p>SparkSQL整合Hive的MetaStore</p><blockquote><p>即使不去整合MetaStore，spark也有一个内置的MetaStore，使用Derby数据库保存数据，但这种方式不适合生产环境。</p></blockquote><p>通过SparkSQL查询Hive的表</p><blockquote><p>查询hive找那个的表可以通过spark。sql()来进行，可以直接在其中访问hive的MetaStore，前提是一定要将hive的配置文件拷贝到spark的conf目录</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=n>spark</span><span class=o>.</span><span class=n>sql</span><span class=o>(</span><span class=s>&#34;use spark_integrition&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>resultDF</span> <span class=k>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>sql</span><span class=o>(</span><span class=s>&#34;select * from student limit 10&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=n>resultDF</span><span class=o>.</span><span class=n>show</span>
</span></span></code></pre></td></tr></table></div></div></blockquote><p><strong>Spark访问Hive中的表</strong></p><p>在Hive中创建表</p><blockquote><ol><li><p>将文件上传到集群hdfs上</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=n>hdfs</span> <span class=n>dfs</span> <span class=o>-</span><span class=n>mkdir</span> <span class=o>-</span><span class=n>p</span> <span class=o>/</span><span class=n>dataset</span>
</span></span><span class=line><span class=cl><span class=n>hdfs</span> <span class=n>dfs</span> <span class=o>-</span><span class=n>put</span> <span class=n>studenttabl10k</span> <span class=o>/</span><span class=n>dataset</span><span class=o>/</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>使用hive或者beeline执行sql</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>database</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>exists</span><span class=w> </span><span class=n>spark_integrition</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>use</span><span class=w> </span><span class=n>spark_integrition</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=k>external</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>student</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>name</span><span class=w> </span><span class=n>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>age</span><span class=w> </span><span class=nb>INT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>gpa</span><span class=w> </span><span class=n>String</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Row</span><span class=w> </span><span class=n>format</span><span class=w> </span><span class=n>delimited</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>fields</span><span class=w> </span><span class=n>terminated</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=s1>&#39;\t&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>lines</span><span class=w> </span><span class=n>terminated</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=s1>&#39;\n&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>stored</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>textfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>location</span><span class=w> </span><span class=s1>&#39;/dataset/hive&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>load</span><span class=w> </span><span class=k>Data</span><span class=w> </span><span class=n>INPATH</span><span class=w> </span><span class=s1>&#39;/dataset/studenttab10k&#39;</span><span class=w> </span><span class=n>OVERWRITE</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>student</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li></ol></blockquote><p>JDBC</p><p>MySQL的访问方式有两种：使用本地运行，提交到集群中运行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-SCALA data-lang=SCALA><span class=line><span class=cl><span class=c1>//读数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>val</span> <span class=n>spark</span> <span class=k>=</span> <span class=nc>SparkSession</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>appName</span><span class=o>(</span><span class=s>&#34;jdbc example&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>master</span><span class=o>(</span><span class=s>&#34;local[6]&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>getOrCreate</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>schema</span> <span class=k>=</span> <span class=nc>StructType</span><span class=o>(</span>
</span></span><span class=line><span class=cl>	<span class=nc>List</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    	<span class=nc>StructField</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>,</span> <span class=nc>StringType</span><span class=o>),</span>
</span></span><span class=line><span class=cl>        <span class=nc>StructField</span><span class=o>(</span><span class=s>&#34;age&#34;</span><span class=o>,</span> <span class=nc>IntegerType</span><span class=o>),</span>
</span></span><span class=line><span class=cl>        <span class=nc>StructField</span><span class=o>(</span><span class=s>&#34;gpa&#34;</span><span class=o>,</span> <span class=nc>FloatType</span><span class=o>),</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>studentDF</span> <span class=k>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>read</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>option</span><span class=o>(</span><span class=s>&#34;delimiter&#34;</span><span class=o>,</span> <span class=s>&#34;\t&#34;</span><span class=o>)</span><span class=c1>//读取文件的分隔符是制表符
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>.</span><span class=n>schema</span><span class=o>(</span><span class=n>schema</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>csv</span><span class=o>(</span><span class=s>&#34;dataset/studenttab10k&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//处理数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>val</span> <span class=n>resultDF</span> <span class=k>=</span> <span class=n>studentDF</span><span class=o>.</span><span class=n>where</span><span class=o>(</span><span class=s>&#34;age&lt;30&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//写数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>resultDF</span><span class=o>.</span><span class=n>write</span><span class=o>.</span><span class=n>format</span><span class=o>(</span><span class=s>&#34;jdbc&#34;</span><span class=o>).</span><span class=n>mode</span><span class=o>(</span><span class=nc>SaveMode</span><span class=o>.</span><span class=nc>Overwrite</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>option</span><span class=o>(</span><span class=s>&#34;url&#34;</span><span class=o>,</span> <span class=s>&#34;jdbc:mysql://node01:3306/spark_test&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>option</span><span class=o>(</span><span class=s>&#34;dbtable&#34;</span><span class=o>,</span> <span class=s>&#34;student&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>option</span><span class=o>(</span><span class=s>&#34;user&#34;</span><span class=o>,</span> <span class=s>&#34;spark&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>option</span><span class=o>(</span><span class=s>&#34;password&#34;</span><span class=o>,</span> <span class=s>&#34;Spark123!&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>save</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=data-type-transformation>Data Type Transformation</h2><p>flatMap,map,mapPartitions,transform,as:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>class</span> <span class=nc>TypedTransformation</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//1.创建sparksession
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>val</span> <span class=n>spark</span> <span class=k>=</span> <span class=nc>SparkSession</span><span class=o>.</span><span class=n>builder</span><span class=o>().</span><span class=n>master</span><span class=o>(</span><span class=s>&#34;local[6]&#34;</span><span class=o>).</span><span class=n>appName</span><span class=o>(</span><span class=s>&#34;typed&#34;</span><span class=o>).</span><span class=n>getOrCreate</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=k>import</span> <span class=nn>spark.implicits._</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=n>trans</span><span class=o>()</span><span class=k>:</span><span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//flatmap
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=n>ds</span> <span class=k>=</span> <span class=nc>Seq</span><span class=o>(</span><span class=s>&#34;hello spark&#34;</span><span class=o>,</span> <span class=s>&#34;hello hadoop&#34;</span><span class=o>).</span><span class=n>toDS</span>
</span></span><span class=line><span class=cl>        <span class=n>ds</span><span class=o>.</span><span class=n>flatMap</span><span class=o>(</span><span class=n>item</span> <span class=k>=&gt;</span> <span class=n>item</span><span class=o>.</span><span class=n>split</span><span class=o>(</span><span class=s>&#34; &#34;</span><span class=o>)).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>//map
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=n>ds2</span> <span class=k>=</span> <span class=nc>Seq</span><span class=o>(</span><span class=nc>Persion</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>15</span><span class=o>),</span><span class=nc>Persion</span><span class=o>(</span><span class=s>&#34;lisi&#34;</span><span class=o>,</span><span class=mi>20</span><span class=o>)).</span><span class=n>toDS</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=n>ds2</span><span class=o>.</span><span class=n>map</span><span class=o>(</span><span class=n>person</span> <span class=k>=&gt;</span> <span class=nc>Person</span><span class=o>(</span><span class=n>person</span><span class=o>.</span><span class=n>name</span><span class=o>,</span> <span class=n>person</span><span class=o>.</span><span class=n>age</span><span class=o>*</span><span class=mi>2</span><span class=o>)).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>//mappartitions
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ds2</span><span class=o>.</span><span class=n>mapPartitions</span><span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>//iter 不能大到每个Executor的内存放不下，不然就会OOM
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>//对每个元素进行转换，后生成一个新的集合
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>iter</span> <span class=o>=&gt;{</span>
</span></span><span class=line><span class=cl>                <span class=k>val</span> <span class=n>result</span> <span class=k>=</span> <span class=n>iter</span><span class=o>.</span><span class=n>map</span><span class=o>(</span><span class=n>person</span> <span class=k>=&gt;</span> <span class=nc>Person</span><span class=o>(</span><span class=n>person</span><span class=o>.</span><span class=n>name</span><span class=o>,</span> <span class=n>person</span><span class=o>.</span><span class=n>age</span> <span class=o>*</span> <span class=mi>2</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=n>trans1</span><span class=o>()</span><span class=k>:</span> <span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=n>ds</span> <span class=k>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>rage</span><span class=o>(</span><span class=mi>10</span><span class=o>)</span> <span class=c1>//0-10
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ds</span><span class=o>.</span><span class=n>transform</span><span class=o>(</span><span class=n>dataset</span> <span class=k>=&gt;</span> <span class=n>dataset</span><span class=o>.</span><span class=n>withColumn</span><span class=o>(</span><span class=s>&#34;doubled&#34;</span><span class=o>,</span> &#39;id <span class=o>*</span> <span class=mi>2</span><span class=err>&#39;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>      <span class=o>.</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>DF转成DS</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=n>rdd</span><span class=o>.</span><span class=n>toDF</span> <span class=o>-&gt;</span> <span class=nc>DataFrame</span> <span class=c1>//toDF把rdd转成DF
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>dataFrame</span> <span class=o>-&gt;</span> <span class=nc>Dataset</span> <span class=c1>//DataFrame就是Dataset[Row]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=k>class</span> <span class=nc>Student</span><span class=o>(</span><span class=n>name</span><span class=k>:</span><span class=kt>String</span><span class=o>,</span> <span class=n>age</span><span class=k>:</span><span class=kt>Int</span><span class=o>,</span> <span class=n>gpa</span><span class=k>:</span><span class=kt>Float</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//读取
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>val</span> <span class=n>schema</span> <span class=k>=</span> <span class=nc>StructType</span><span class=o>(</span>
</span></span><span class=line><span class=cl>	<span class=nc>Seq</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    	<span class=nc>StructField</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>,</span><span class=nc>StringType</span><span class=o>),</span>
</span></span><span class=line><span class=cl>        <span class=nc>StructField</span><span class=o>(</span><span class=s>&#34;age&#34;</span><span class=o>,</span><span class=nc>IntegerType</span><span class=o>),</span>
</span></span><span class=line><span class=cl>        <span class=nc>StructField</span><span class=o>(</span><span class=s>&#34;gpa&#34;</span><span class=o>,</span><span class=nc>FloatType</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>df</span> <span class=k>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>read</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>schema</span><span class=o>(</span><span class=n>schema</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>option</span><span class=o>(</span><span class=s>&#34;delimiter&#34;</span><span class=o>,</span><span class=s>&#34;\t&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>csv</span><span class=o>(</span><span class=s>&#34;dataset/studenttab10k&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=c1>//转换
</span></span></span><span class=line><span class=cl><span class=c1>//本质上dataset[Row].as[Student] =&gt; Dataset[Student]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>val</span> <span class=n>ds</span><span class=k>:</span> <span class=kt>Dataset</span><span class=o>[</span><span class=kt>Student</span><span class=o>]</span> <span class=k>=</span> <span class=n>df</span><span class=o>.</span><span class=n>as</span><span class=o>[</span><span class=kt>Student</span><span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//输出
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ds</span><span class=o>.</span><span class=n>show</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><p>Filter</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>filter</span><span class=o>()</span><span class=k>:</span> <span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=n>ds</span> <span class=k>=</span> <span class=nc>Seq</span><span class=o>(</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>15</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;ls&#34;</span><span class=o>,</span><span class=mi>20</span><span class=o>)).</span><span class=n>toDS</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=n>ds</span><span class=o>.</span><span class=n>filter</span><span class=o>(</span><span class=n>person</span> <span class=k>=&gt;</span> <span class=n>person</span><span class=o>.</span><span class=n>age</span> <span class=o>&gt;</span> <span class=mi>15</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Group</p><p>groupByKey:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>val</span> <span class=n>ds</span> <span class=k>=</span> <span class=nc>Seq</span><span class=o>(</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>15</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;ls&#34;</span><span class=o>,</span><span class=mi>20</span><span class=o>)).</span><span class=n>toDS</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>grouped</span><span class=k>:</span> <span class=kt>KeyValueGroupedDataset</span><span class=o>[</span><span class=kt>String</span>, <span class=kt>Person</span><span class=o>]</span> <span class=k>=</span> <span class=n>ds</span><span class=o>.</span><span class=n>groupByKey</span><span class=o>(</span><span class=n>person</span> <span class=k>=&gt;</span> <span class=n>person</span><span class=o>.</span><span class=n>name</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>result</span><span class=k>:</span> <span class=kt>Dataset</span><span class=o>[(</span><span class=kt>String</span>, <span class=kt>Long</span><span class=o>)]</span> <span class=k>=</span> <span class=n>grouped</span><span class=o>.</span><span class=n>count</span><span class=o>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>result</span><span class=o>.</span><span class=n>show</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><p>Split</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>val</span> <span class=n>ds</span> <span class=k>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>range</span><span class=o>(</span><span class=mi>15</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=c1>//randomSplit, the number of part, weight
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>val</span> <span class=n>datasets</span><span class=k>:</span> <span class=kt>Array</span><span class=o>[</span><span class=kt>Dataset</span><span class=o>[</span><span class=kt>lang.Long</span><span class=o>]]</span> <span class=k>=</span><span class=n>ds</span><span class=o>.</span><span class=n>randomSplit</span><span class=o>(</span><span class=nc>Array</span><span class=o>(</span><span class=mi>5</span><span class=o>,</span><span class=mi>2</span><span class=o>,</span><span class=mi>3</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=n>datasets</span><span class=o>.</span><span class=n>foeach</span><span class=o>(</span><span class=k>_</span><span class=o>.</span><span class=n>show</span><span class=o>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//split
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ds</span><span class=o>.</span><span class=n>sample</span><span class=o>(</span><span class=n>withReplacement</span> <span class=k>=</span> <span class=kc>false</span><span class=o>,</span> <span class=n>fraction</span> <span class=k>=</span> <span class=mf>0.4</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><p>Sort</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>val</span> <span class=n>ds</span> <span class=k>=</span> <span class=nc>Seq</span><span class=o>(</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>15</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;ls&#34;</span><span class=o>,</span><span class=mi>20</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>8</span><span class=o>)).</span><span class=n>toDS</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=n>orderBy</span><span class=o>(</span>&#39;name<span class=o>.</span><span class=n>desc</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=n>sort</span><span class=o>(</span>&#39;name<span class=o>.</span><span class=n>asc</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><p>Distinct</p><p>distinct,dropDuplicates:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>dropDuplicates</span><span class=o>()</span><span class=k>:</span> <span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=n>ds</span> <span class=k>=</span> <span class=nc>Seq</span><span class=o>(</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>15</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;ls&#34;</span><span class=o>,</span><span class=mi>20</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>8</span><span class=o>)).</span><span class=n>toDS</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>//重复列完全匹配
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ds</span><span class=o>.</span><span class=n>distinct</span><span class=o>().</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>//指定列去重
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ds</span><span class=o>.</span><span class=n>dropDuplicates</span><span class=o>(</span><span class=s>&#34;age&#34;</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Collection</p><p>差集、交集、并集、limit</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>collection</span><span class=o>()</span><span class=k>:</span> <span class=kt>Unit</span> <span class=o>={</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=n>ds1</span> <span class=k>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>range</span><span class=o>(</span><span class=mi>1</span><span class=o>,</span><span class=mi>10</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=n>ds2</span> <span class=k>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>range</span><span class=o>(</span><span class=mi>5</span><span class=o>,</span><span class=mi>15</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ds1</span><span class=o>.</span><span class=n>except</span><span class=o>(</span><span class=n>ds2</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ds1</span><span class=o>.</span><span class=n>intersect</span><span class=o>(</span><span class=n>ds2</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ds1</span><span class=o>.</span><span class=n>union</span><span class=o>(</span><span class=n>ds2</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>ds1</span><span class=o>.</span><span class=n>limit</span><span class=o>(</span><span class=mi>3</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=data-typeless-transformation>Data Typeless Transformation</h2><p>select</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>val</span> <span class=n>ds</span> <span class=k>=</span> <span class=nc>Seq</span><span class=o>(</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>15</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;ls&#34;</span><span class=o>,</span><span class=mi>20</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>8</span><span class=o>)).</span><span class=n>toDS</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=n>sort</span><span class=o>()</span>
</span></span><span class=line><span class=cl>  <span class=o>....</span>
</span></span><span class=line><span class=cl>  <span class=o>.</span><span class=n>secect</span><span class=o>(</span>&#39;name<span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=n>selectExpr</span><span class=o>(</span><span class=s>&#34;sum(age)&#34;</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>import</span> <span class=nn>org.apache.spark.sql.funcitons._</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=n>select</span><span class=o>(</span><span class=n>exper</span><span class=o>(</span><span class=s>&#34;sum(age)&#34;</span><span class=o>)).</span><span class=n>show</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><p>Column</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>val</span> <span class=n>ds</span> <span class=k>=</span> <span class=nc>Seq</span><span class=o>(</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>15</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;ls&#34;</span><span class=o>,</span><span class=mi>20</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>8</span><span class=o>)).</span><span class=n>toDS</span><span class=o>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>import</span> <span class=nn>org.apache.spark.sql.funcitons._</span>
</span></span><span class=line><span class=cl><span class=c1>//如果想使用函数的功能
</span></span></span><span class=line><span class=cl><span class=c1>//1.使用functions.xx
</span></span></span><span class=line><span class=cl><span class=c1>//2.使用表达式，可以使用expr(&#34;...&#34;)随时编写表达式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ds</span><span class=o>.</span><span class=n>withColumn</span><span class=o>(</span><span class=s>&#34;random&#34;</span><span class=o>,</span><span class=n>expr</span><span class=o>(</span><span class=s>&#34;rand()&#34;</span><span class=o>)).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=n>withColumn</span><span class=o>(</span><span class=s>&#34;name_new&#34;</span><span class=o>,</span>&#39;name <span class=o>+</span> <span class=o>...).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=n>withColumn</span><span class=o>(</span><span class=s>&#34;name_jok&#34;</span><span class=o>,</span>&#39;name <span class=o>===</span> <span class=s>&#34;&#34;</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=n>withColumnRenamed</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>,</span><span class=s>&#34;new_name&#34;</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><p>Drop</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>val</span> <span class=n>ds</span> <span class=k>=</span> <span class=nc>Seq</span><span class=o>(</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>15</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;ls&#34;</span><span class=o>,</span><span class=mi>20</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>8</span><span class=o>)).</span><span class=n>toDS</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=n>drop</span><span class=o>(</span>&#39;age<span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><p>GroupBy</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>val</span> <span class=n>ds</span> <span class=k>=</span> <span class=nc>Seq</span><span class=o>(</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>15</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;ls&#34;</span><span class=o>,</span><span class=mi>20</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>8</span><span class=o>)).</span><span class=n>toDS</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=c1>//为什么groupByKey是有类型的，最主要的原因是因为groupByKey所生成的对象中的算子是有类型的
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ds</span><span class=o>.</span><span class=n>groupByKey</span><span class=o>(</span><span class=n>item</span> <span class=k>=&gt;</span> <span class=n>item</span><span class=o>.</span><span class=n>name</span><span class=o>).</span><span class=n>mapValues</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=c1>//为什么groupBy是无类型的，因为groupBy所生成的对象中的算子是无类型的，针对列进行处理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ds</span><span class=o>.</span><span class=n>groupBy</span><span class=o>(</span>&#39;name<span class=o>).</span><span class=n>agg</span><span class=o>(</span><span class=n>mean</span><span class=o>(</span><span class=s>&#34;age&#34;</span><span class=o>)).</span><span class=n>show</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=column>Column</h2><p>Creation</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>class</span> <span class=nc>Column</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>val</span> <span class=n>spark</span> <span class=k>=</span> <span class=nc>SparkSession</span><span class=o>.</span><span class=n>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>master</span><span class=o>(</span><span class=s>&#34;local[6]&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>appName</span><span class=o>(</span><span class=s>&#34;column&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>getOrCreate</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=n>creation</span><span class=o>()</span><span class=k>:</span><span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=n>ds</span> <span class=k>=</span> <span class=nc>Seq</span><span class=o>(</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>15</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;ls&#34;</span><span class=o>,</span><span class=mi>20</span><span class=o>),</span><span class=nc>Person</span><span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>8</span><span class=o>)).</span><span class=n>toDS</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=n>df</span> <span class=k>=</span> <span class=nc>Seq</span><span class=o>((</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>15</span><span class=o>),(</span><span class=s>&#34;ls&#34;</span><span class=o>,</span><span class=mi>20</span><span class=o>),(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=mi>8</span><span class=o>)).</span><span class=n>toDF</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>,</span><span class=s>&#34;age&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>//1. &#39; 必须导入spark的隐式转化才能使用str.intern()
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=n>column</span><span class=k>:</span> <span class=kt>Symbol</span> <span class=o>=</span> &#39;name
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>//2. $ 必须导入spark的隐式转化才能使用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=n>column1</span><span class=k>:</span> <span class=kt>ColumnName</span> <span class=o>=</span> <span class=n>$</span><span class=s>&#34;name&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>//3. col 必须导入functions
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>import</span> <span class=nn>org.apache.spark.sql.functions._</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=n>column2</span><span class=k>:</span><span class=kt>sql.Column</span> <span class=o>=</span> <span class=n>col</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>//4. column 必须导入functions
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=n>column3</span><span class=k>:</span><span class=kt>sql.Column</span> <span class=o>=</span> <span class=n>column</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>//Dataset可以，DataFrame可以使用column对象
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ds</span><span class=o>.</span><span class=n>select</span><span class=o>(</span><span class=n>column</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=o>.</span><span class=n>select</span><span class=o>(</span><span class=n>column</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>//column有四种创建方式
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//column对象可以用作于Dataset和DataFrame中
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//column可以和命令式的弱类型的API配合使用:select where
</span></span></span><span class=line><span class=cl><span class=c1></span>        
</span></span><span class=line><span class=cl>        <span class=c1>//5. dataset.col
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//使用dataset来获取column对象，会和某个dataset进行绑定，在逻辑计划中，就会有不同的表现
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=n>column4</span> <span class=k>=</span> <span class=n>ds</span><span class=o>.</span><span class=n>col</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=n>column5</span> <span class=k>=</span> <span class=n>ds1</span><span class=o>.</span><span class=n>col</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ds</span><span class=o>.</span><span class=n>select</span><span class=o>(</span><span class=n>column5</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>//为什么要和dataset来绑定呢？
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ds</span><span class=o>.</span><span class=n>join</span><span class=o>(</span><span class=n>ds1</span><span class=o>,</span> <span class=n>ds</span><span class=o>.</span><span class=n>col</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>)</span> <span class=o>===</span> <span class=n>ds1</span><span class=o>.</span><span class=n>col</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1>//6. dataset.apply
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=n>column6</span> <span class=k>=</span> <span class=n>ds</span><span class=o>.</span><span class=n>apply</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=n>column7</span> <span class=k>=</span> <span class=n>ds</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Type</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=n>select</span><span class=o>(</span>&#39;name <span class=n>as</span> <span class=s>&#34;new_name&#34;</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=n>ds</span><span class=o>.</span><span class=n>select</span><span class=o>(</span>&#39;age<span class=o>.</span><span class=n>as</span><span class=o>[</span><span class=kt>Long</span><span class=o>]).</span><span class=n>show</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><p>API</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=c1>//添加新列
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>df</span><span class=o>.</span><span class=n>withColun</span><span class=o>(</span><span class=s>&#34;age&#34;</span><span class=o>,</span> &#39;age <span class=o>*</span> <span class=mi>2</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=c1>//模糊查询
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ds</span><span class=o>.</span><span class=n>where</span><span class=o>(</span>&#39;name <span class=n>like</span> <span class=s>&#34;zhang%&#34;</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=c1>//排序
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ds</span><span class=o>.</span><span class=n>sort</span><span class=o>(</span>&#39;age <span class=n>asc</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=c1>//枚举判断
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ds</span><span class=o>.</span><span class=n>where</span><span class=o>(</span>&#39;name <span class=n>isin</span> <span class=o>(</span><span class=s>&#34;zs&#34;</span><span class=o>,</span><span class=s>&#34;wu&#34;</span><span class=o>,</span><span class=s>&#34;ls&#34;</span><span class=o>)).</span><span class=n>show</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=na>N/A</h2><p>缺失值的处理：</p><ol><li>丢弃缺失值的行</li><li>替换初始值</li></ol><p>DataFrameNaFunctions</p><ol><li><p>创建</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>val</span> <span class=n>naf</span><span class=k>:</span> <span class=kt>DataFrameNaFunctions</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>na</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>功能</p><blockquote><p>naf.drop&mldr; naf.fill &mldr;</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>na</span><span class=o>.</span><span class=n>drop</span><span class=o>.</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=o>.</span><span class=n>na</span><span class=o>.</span><span class=n>fill</span><span class=o>.</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>NullProcessor</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=n>nullAndNaN</span><span class=o>()</span><span class=k>:</span> <span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//ss
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=n>spark</span> <span class=k>=</span> <span class=nc>SparkSession</span><span class=o>.</span><span class=n>builder</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        	<span class=o>.</span><span class=n>master</span><span class=o>(</span><span class=s>&#34;local[6]&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        	<span class=o>.</span><span class=n>appName</span><span class=o>(</span><span class=s>&#34;null processor&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        	<span class=o>.</span><span class=n>getOrCreate</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>//导入
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=c1>//读取
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//	1.通过spark-csv自动的推断类型来读取，推断数字的时候会将NaN推断为字符串
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>spark</span><span class=o>.</span><span class=n>read</span>
</span></span><span class=line><span class=cl>        	<span class=o>.</span><span class=n>option</span><span class=o>(</span><span class=s>&#34;header&#34;</span><span class=o>,</span> <span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        	<span class=o>.</span><span class=n>option</span><span class=o>(</span><span class=s>&#34;inferSchema&#34;</span><span class=o>,</span><span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        	<span class=o>.</span><span class=n>csv</span><span class=o>(</span><span class=n>dataset</span><span class=o>/</span><span class=n>ds</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>//	2.直接读取字符串，在后续的操作中使用map算子转换类型
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>spark</span><span class=o>.</span><span class=n>read</span><span class=o>.</span><span class=n>csv</span><span class=o>().</span><span class=n>map</span><span class=o>(</span><span class=n>row</span> <span class=k>=&gt;</span> <span class=n>row</span><span class=o>...)</span>
</span></span><span class=line><span class=cl>        <span class=c1>//	3.指定Schema,不要自动推断
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>val</span> <span class=n>schema</span> <span class=k>=</span> <span class=n>structType</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        	<span class=n>list</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=nc>StructField</span><span class=o>(</span><span class=s>&#34;id&#34;</span><span class=o>,</span><span class=nc>LongType</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                <span class=nc>StructField</span><span class=o>(</span><span class=s>&#34;year&#34;</span><span class=o>,</span><span class=nc>IntegerType</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                <span class=nc>StructField</span><span class=o>(</span><span class=s>&#34;day&#34;</span><span class=o>,</span><span class=nc>IntegerType</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                <span class=nc>StructField</span><span class=o>(</span><span class=s>&#34;season&#34;</span><span class=o>,</span><span class=nc>IntegerType</span><span class=o>),</span>
</span></span><span class=line><span class=cl>                <span class=nc>StructField</span><span class=o>(</span><span class=s>&#34;pm&#34;</span><span class=o>,</span><span class=nc>DoubleType</span><span class=o>)</span>
</span></span><span class=line><span class=cl>            <span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=n>sourceDF</span> <span class=k>=</span> <span class=n>spark</span><span class=o>.</span><span class=n>read</span>
</span></span><span class=line><span class=cl>        	<span class=o>.</span><span class=n>option</span><span class=o>(</span><span class=s>&#34;header&#34;</span><span class=o>,</span> <span class=n>value</span> <span class=k>=</span> <span class=kc>true</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        	<span class=o>.</span><span class=n>schema</span><span class=o>(</span><span class=n>schema</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        	<span class=o>.</span><span class=n>csv</span><span class=o>(</span><span class=s>&#34;dataset/data.csv&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        	<span class=o>.</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>//丢弃
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//	规则：
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//		1.any：只要有一个NaN就丢弃
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>sourceDF</span><span class=o>.</span><span class=n>na</span><span class=o>.</span><span class=n>drop</span><span class=o>(</span><span class=s>&#34;any&#34;</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=n>sourceDF</span><span class=o>.</span><span class=n>na</span><span class=o>.</span><span class=n>drop</span><span class=o>().</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>//		2.all: 所有数据NaN才丢弃
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>sourceDF</span><span class=o>.</span><span class=n>na</span><span class=o>.</span><span class=n>drop</span><span class=o>(</span><span class=s>&#34;all&#34;</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>//		3.某些列
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>sourceDF</span><span class=o>.</span><span class=n>na</span><span class=o>.</span><span class=n>drop</span><span class=o>(</span><span class=s>&#34;any&#34;</span><span class=o>,</span><span class=nc>List</span><span class=o>(</span><span class=s>&#34;year&#34;</span><span class=o>,</span><span class=s>&#34;month&#34;</span><span class=o>,</span><span class=s>&#34;day&#34;</span><span class=o>)).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>//填充
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//	规则：
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//		1.针对所有列默认值填充
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>sourceDF</span><span class=o>.</span><span class=n>na</span><span class=o>.</span><span class=n>fill</span><span class=o>(</span><span class=mi>0</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>//		2.针对特定列填充
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>sourceDF</span><span class=o>.</span><span class=n>na</span><span class=o>.</span><span class=n>fill</span><span class=o>(</span><span class=mi>0</span><span class=o>,</span><span class=nc>List</span><span class=o>(</span><span class=s>&#34;year&#34;</span><span class=o>,</span> <span class=s>&#34;month&#34;</span><span class=o>)).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>SparkSQL处理异常字符串:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>strProcessor</span><span class=o>()</span><span class=k>:</span> <span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//1.丢弃
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>import</span> <span class=nn>spark.implicits._</span>
</span></span><span class=line><span class=cl>    <span class=n>sourceDF</span><span class=o>.</span><span class=n>where</span><span class=o>(</span>&#39;PM_dongsi <span class=o>=!=</span> <span class=s>&#34;NA&#34;</span><span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>//2.替换
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>import</span> <span class=nn>org.apache.spark.sql.functions._</span>
</span></span><span class=line><span class=cl>    <span class=n>sourceDF</span><span class=o>.</span><span class=n>select</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    	&#39;No <span class=n>as</span> <span class=s>&#34;id&#34;</span><span class=o>,</span> &#39;year<span class=o>,</span> &#39;month<span class=o>,</span> &#39;day<span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>when</span><span class=o>(</span>&#39;PM_Dongsi <span class=o>===</span> <span class=s>&#34;NA&#34;</span><span class=o>,</span> <span class=nc>Double</span><span class=o>.</span><span class=nc>NaN</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>otherwise</span><span class=o>(</span>&#39;PM_Dongsi <span class=n>cast</span> <span class=nc>DoubleType</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>as</span><span class=o>(</span><span class=s>&#34;pm&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sourceDF</span><span class=o>.</span><span class=n>na</span><span class=o>.</span><span class=n>replace</span><span class=o>(</span><span class=s>&#34;PM_Dongsi&#34;</span><span class=o>,</span> <span class=nc>Map</span><span class=o>(</span><span class=s>&#34;NA&#34;</span> <span class=o>-&gt;</span> <span class=s>&#34;NaN&#34;</span><span class=o>,</span> <span class=s>&#34;NULL&#34;</span> <span class=o>-&gt;</span> <span class=s>&#34;null&#34;</span><span class=o>)).</span><span class=n>show</span><span class=o>()</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><h2 id=groupby>groupBy</h2><p><strong>groupBy</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=c1>//分组
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>val</span> <span class=n>groupedDF</span> <span class=k>=</span> <span class=n>cleanDF</span><span class=o>.</span><span class=n>groupBy</span><span class=o>(</span><span class=n>$</span><span class=s>&#34;year&#34;</span><span class=o>,</span><span class=n>$</span><span class=s>&#34;month&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=c1>//使用functions函数来完成聚合
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>import</span> <span class=nn>org.apache.spark.sql.functions._</span>
</span></span><span class=line><span class=cl><span class=n>groupedDF</span><span class=o>.</span><span class=n>agg</span><span class=o>(</span><span class=n>avg</span><span class=o>(</span><span class=n>$</span><span class=s>&#34;pm&#34;</span><span class=o>)</span> <span class=n>as</span> <span class=s>&#34;pm_avg&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>orderBy</span><span class=o>(</span><span class=n>$</span><span class=s>&#34;pm_avg&#34;</span><span class=o>.</span><span class=n>desc</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//分组第二种方式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>groupedDF</span><span class=o>.</span><span class=n>avg</span><span class=o>(</span><span class=s>&#34;pm&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>select</span><span class=o>(</span><span class=n>$</span><span class=s>&#34;avg(pm)&#34;</span> <span class=n>as</span> <span class=s>&#34;pm_avg&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>orderBy</span><span class=o>(</span><span class=s>&#34;pm_avg&#34;</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>多维聚合</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=c1>//requirement 1:不同年，不同来源PM值的平均数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>val</span> <span class=n>postAndYearDF</span> <span class=k>=</span> <span class=n>pmFinal</span><span class=o>.</span><span class=n>groupBy</span><span class=o>(</span>&#39;source<span class=o>,</span>&#39;year<span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>agg</span><span class=o>(</span><span class=n>avg</span><span class=o>(</span><span class=nc>$pm</span><span class=o>)</span> <span class=n>as</span> <span class=s>&#34;pm&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//requirement 2:按照不同的来源统计PM值的平均数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>val</span> <span class=n>postDF</span> <span class=k>=</span> <span class=n>pmFinal</span><span class=o>.</span><span class=n>groupBy</span><span class=o>(</span><span class=nc>$source</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>agg</span><span class=o>(</span><span class=n>avg</span><span class=o>(</span><span class=nc>$pm</span><span class=o>)</span> <span class=n>as</span> <span class=s>&#34;pm&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>select</span><span class=o>(</span><span class=nc>$source</span><span class=o>,</span> <span class=n>lit</span><span class=o>(</span><span class=kc>null</span><span class=o>)</span> <span class=n>as</span> <span class=s>&#34;year&#34;</span><span class=o>,</span> <span class=nc>$pm</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//合并在同一个结果集中
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>postAndYearDF</span><span class=o>.</span><span class=n>union</span><span class=o>(</span><span class=n>postDF</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>sort</span><span class=o>(</span><span class=nc>$source</span><span class=o>,</span> <span class=nc>$year</span> <span class=n>asc_nulls_last</span><span class=o>,</span> <span class=nc>$pm</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>rollup</strong></p><p>滚动分组：rollup(A, B)，生成三列：AB分组，A null分组，null(全局)的分组</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=c1>//requirement 1: 每个城市，每年的销售额
</span></span></span><span class=line><span class=cl><span class=c1>//requirement 2: 每个城市，一共的销售额
</span></span></span><span class=line><span class=cl><span class=c1>//requirement 3: 总体销售额
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>val</span> <span class=n>sales</span> <span class=k>=</span> <span class=nc>Seq</span><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=o>(</span><span class=s>&#34;Bj&#34;</span><span class=o>,</span> <span class=mi>2016</span><span class=o>,</span> <span class=mi>100</span><span class=o>),</span>
</span></span><span class=line><span class=cl>    <span class=o>(</span><span class=s>&#34;Bj&#34;</span><span class=o>,</span> <span class=mi>2017</span><span class=o>,</span> <span class=mi>200</span><span class=o>),</span>
</span></span><span class=line><span class=cl>    <span class=o>(</span><span class=s>&#34;shanghai&#34;</span><span class=o>,</span> <span class=mi>2015</span><span class=o>,</span> <span class=mi>50</span><span class=o>),</span>
</span></span><span class=line><span class=cl>    <span class=o>(</span><span class=s>&#34;shanghai&#34;</span><span class=o>,</span> <span class=mi>2016</span><span class=o>,</span> <span class=mi>150</span><span class=o>),</span>
</span></span><span class=line><span class=cl>    <span class=o>(</span><span class=s>&#34;Guangzhou&#34;</span><span class=o>,</span> <span class=mi>2017</span><span class=o>,</span> <span class=mi>50</span><span class=o>),</span>
</span></span><span class=line><span class=cl><span class=o>).</span><span class=n>toDF</span><span class=o>(</span><span class=s>&#34;city&#34;</span><span class=o>,</span> <span class=s>&#34;year&#34;</span><span class=o>,</span> <span class=s>&#34;amount&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sales</span><span class=o>.</span><span class=n>rollup</span><span class=o>(</span><span class=nc>$city</span><span class=o>,</span> <span class=nc>$year</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>agg</span><span class=o>(</span><span class=n>sum</span><span class=o>(</span><span class=nc>$amount</span><span class=o>)</span> <span class=n>as</span> <span class=s>&#34;amount&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>sort</span><span class=o>(</span><span class=nc>$city</span> <span class=n>asc</span> <span class=n>asc_nulls_last</span><span class=o>,</span> <span class=nc>$year</span><span class=o>.</span><span class=n>asc_nulls_last</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>cube</strong></p><p>rollup对参数顺序有要求，cube是对rollup的弥补</p><p>rollup(A, B)，生成四列：AB分组，A null分组，null B分组，null(全局)的分组</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>import</span> <span class=nn>org.apache.spark.sql.functions._</span>
</span></span><span class=line><span class=cl><span class=n>pmFinal</span><span class=o>.</span><span class=n>cube</span><span class=o>(</span><span class=nc>$source</span><span class=o>,</span> <span class=nc>$year</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>agg</span><span class=o>(</span><span class=n>avg</span><span class=o>(</span><span class=nc>$pm</span><span class=o>)</span> <span class=n>as</span> <span class=s>&#34;pm&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>sort</span><span class=o>(</span><span class=nc>$source</span><span class=o>.</span><span class=n>asc_nulls_last</span><span class=o>,</span> <span class=nc>$year</span><span class=o>.</span><span class=n>asc_nulls_last</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>RelationalGroupedDataset</strong></p><p>groupBy, rollup, cube后的数据类型都是RelationalGroupedDataset</p><p>RelationalGroupedDataset并不是DataFrame，所以其中并没有DataFrame的方法，只有如下一些聚合相关的方法，下列方法调用后会生成DataFrame对象，然后就可以再次使用DataFrame的算子进行操作</p><table><thead><tr><th>操作符</th><th>解释</th></tr></thead><tbody><tr><td>avg</td><td>average</td></tr><tr><td>count</td><td>count</td></tr><tr><td>max</td><td>max</td></tr><tr><td>min</td><td>min</td></tr><tr><td>mean</td><td>average</td></tr><tr><td>sum</td><td>sum</td></tr><tr><td>agg</td><td>聚合，可以使用sql.funcitons中的函数来配合进行操作<br><code>pmDf.groupBy($year).agg(avg($pm) as "pm_avg")</code></td></tr></tbody></table><h2 id=table-join>Table Join</h2><p><strong>Join</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>class</span> <span class=nc>JoinProcessor</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//create Spark
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//import implicits._
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nd>@Test</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=n>introJoin</span><span class=o>()</span><span class=k>:</span> <span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=n>person</span> <span class=k>=</span> <span class=nc>Seq</span><span class=o>((</span><span class=mi>0</span><span class=o>,</span> <span class=s>&#34;Lu&#34;</span><span class=o>,</span> <span class=mi>0</span><span class=o>),</span> <span class=o>(</span><span class=mi>1</span><span class=o>,</span> <span class=s>&#34;Li&#34;</span><span class=o>,</span> <span class=mi>0</span><span class=o>),</span> <span class=o>(</span><span class=mi>2</span><span class=o>,</span><span class=s>&#34;Tim&#34;</span><span class=o>,</span> <span class=mi>0</span><span class=o>))</span>
</span></span><span class=line><span class=cl>        	<span class=o>.</span><span class=n>toDF</span><span class=o>(</span><span class=s>&#34;id&#34;</span><span class=o>,</span> <span class=s>&#34;name&#34;</span><span class=o>,</span> <span class=s>&#34;cityID&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=n>cities</span> <span class=k>=</span> <span class=nc>Seq</span><span class=o>((</span><span class=mi>0</span><span class=o>,</span> <span class=s>&#34;BJ&#34;</span><span class=o>),</span> <span class=o>(</span><span class=mi>1</span><span class=o>,</span> <span class=s>&#34;SH&#34;</span><span class=o>),</span> <span class=o>(</span><span class=mi>2</span><span class=o>,</span><span class=s>&#34;GZ&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>        	<span class=o>.</span><span class=n>toDF</span><span class=o>(</span><span class=s>&#34;id&#34;</span><span class=o>,</span> <span class=s>&#34;name&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>val</span> <span class=n>df</span> <span class=k>=</span> <span class=n>person</span><span class=o>.</span><span class=n>join</span><span class=o>(</span><span class=n>cities</span><span class=o>,</span> <span class=n>person</span><span class=o>.</span><span class=n>col</span><span class=o>(</span><span class=s>&#34;cityID&#34;</span><span class=o>)</span> <span class=o>===</span> <span class=n>cities</span><span class=o>.</span><span class=n>col</span><span class=o>(</span><span class=s>&#34;id&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>        	<span class=o>.</span><span class=n>select</span><span class=o>(</span><span class=n>person</span><span class=o>.</span><span class=n>col</span><span class=o>(</span><span class=s>&#34;id&#34;</span><span class=o>),</span><span class=n>person</span><span class=o>.</span><span class=n>col</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>),</span><span class=n>cities</span><span class=o>.</span><span class=n>col</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>df</span><span class=o>.</span><span class=n>createOrReplaceTempView</span><span class=o>(</span><span class=s>&#34;user_city&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>cross</strong></p><p>交叉连接，笛卡尔积</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>def</span> <span class=n>crossJoin</span><span class=o>()</span><span class=k>:</span> <span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>person</span><span class=o>.</span><span class=n>crossJoin</span><span class=o>(</span><span class=n>cities</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    	<span class=o>.</span><span class=n>where</span><span class=o>(</span><span class=n>person</span><span class=o>.</span><span class=n>col</span><span class=o>(</span><span class=s>&#34;cityId&#34;</span><span class=o>)</span> <span class=o>===</span> <span class=n>cities</span><span class=o>.</span><span class=n>col</span><span class=o>(</span><span class=s>&#34;id&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>spark</span><span class=o>.</span><span class=n>sql</span><span class=o>(</span><span class=s>&#34;select u.id, u.name, from person u cross join cities c&#34;</span> <span class=o>+</span> <span class=s>&#34;where u.cityId = c.id&#34;</span><span class=o>)</span> 
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>inner</strong></p><p>交集</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>person</span><span class=w> </span><span class=k>inner</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=n>cities</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>person</span><span class=p>.</span><span class=n>cityId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cities</span><span class=p>.</span><span class=n>id</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=n>person</span><span class=o>.</span><span class=n>join</span><span class=o>(</span><span class=n>right</span> <span class=k>=</span> <span class=n>cities</span><span class=o>,</span>
</span></span><span class=line><span class=cl>           <span class=n>joinExprs</span> <span class=k>=</span> <span class=n>person</span><span class=o>(</span><span class=s>&#34;cityId&#34;</span><span class=o>)</span> <span class=o>===</span> <span class=n>citeis</span><span class=o>(</span><span class=s>&#34;id&#34;</span><span class=o>),</span>
</span></span><span class=line><span class=cl>           <span class=n>joinType</span> <span class=k>=</span> <span class=s>&#34;inner&#34;</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>outer</strong></p><p>全外连接</p><p>内连接的结果只有连接上的数据，而全外连接可以包含没有连接上的数据。</p><p><strong>leftouter</strong></p><p>左外连接</p><p>全外连接含没有连接上的数据，左外连接只包含左边没有连接上的数据。</p><p><strong>semi&anti</strong></p><p>Semi-join
通常出现在使用了exists或in的sql中，所谓semi-join即在两表关联时，当第二个表中存在一个或多个匹配记录时，返回第一个表的记录；
与普通join的区别在于semi-join时，第一个表里的记录最多只返回一次；</p><p>Anti-join
而anti-join则与semi-join相反，即当在第二张表没有发现匹配记录时，才会返回第一张表里的记录；
当使用not exists/not in的时候会用到，两者在处理null值的时候会有所区别</p><ol><li>使用not in且相应列有not null约束</li><li>not exists，不保证每次都用到anti-join代</li></ol><h2 id=udf>UDF</h2><p>自定义列操作函数</p><h2 id=over-rank>Over Rank</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=c1>//1定义窗口
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>val</span> <span class=n>window</span> <span class=k>=</span> <span class=nc>Window</span><span class=o>.</span><span class=n>partitionBy</span><span class=o>(</span><span class=nc>$category</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>orderBy</span><span class=o>(</span><span class=nc>$revenue</span><span class=o>.</span><span class=n>desc</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//2处理数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>import</span> <span class=nn>org.apache.spark.sql.functions._</span>
</span></span><span class=line><span class=cl><span class=n>source</span><span class=o>.</span><span class=n>select</span><span class=o>(</span><span class=nc>$production</span><span class=o>,</span> <span class=nc>$category</span><span class=o>,</span> <span class=n>dense_rank</span><span class=o>()</span> <span class=n>over</span> <span class=n>window</span> <span class=n>as</span> <span class=s>&#34;rank&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>where</span><span class=o>(</span><span class=nc>$rank</span> <span class=o>&lt;=</span> <span class=mi>2</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=o>.</span><span class=n>show</span><span class=o>()</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/distribution/>Distribution</a>,&nbsp;<a href=/tags/spark/>Spark</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/20200615_hive-key-point/ class=prev rel=prev title="Hive Key Points"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Hive Key Points</a>
<a href=/20200803_spark-guide3/ class=next rel=next title="Spark Guide, Part Ⅲ">Spark Guide, Part Ⅲ<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2018 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=about target=_blank></a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/valine@1.5.0/dist/Valine.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/typeit@8.6.0/dist/index.umd.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:40},comment:{valine:{appId:"2jSYKh8PFUje3v7Ie3Nn5v1g-gzGzoHsz",appKey:"MyWn4P9G5N32q3oM5JDnlpdL",avatar:"retro",el:"#valine",emojiCDN:"https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/",enableQQ:!0,highlight:!0,lang:"en",meta:["nick","mail"],pageSize:10,placeholder:"Your comment ...",recordIP:!0,visitor:!0}},data:{"id-1":"JERRYSBLOG","id-2":"JERRYSBLOG"},lightgallery:!0,search:{algoliaAppID:"BADKNNRXHD",algoliaIndex:"index",algoliaSearchKey:"7a8c2923330a44bdd9985698e3f28e0c",highlightTag:"em",maxResultLength:6,noResultsFound:"No results found",snippetLength:30,type:"algolia"},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:0,speed:100}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>