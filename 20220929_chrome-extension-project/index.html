<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Chrome Extension Project: Weibo Advertising Filter - JerrysBlog</title><meta name=Description content><meta property="og:title" content="Chrome Extension Project: Weibo Advertising Filter"><meta property="og:description" content="A Chrome extension is a small software program that is designed to add functionality to the Google Chrome web browser. Extensions can be developed using web technologies such as HTML, CSS, and JavaScript. Therefore, JavaScript is often used in the development of Chrome extensions to add interactivity and to implement the logic of the extension."><meta property="og:type" content="article"><meta property="og:url" content="https://jerrysmd.github.io/20220929_chrome-extension-project/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-29T12:05:56+08:00"><meta property="article:modified_time" content="2022-09-29T12:05:56+08:00"><meta property="og:site_name" content="JerrysBlog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Chrome Extension Project: Weibo Advertising Filter"><meta name=twitter:description content="A Chrome extension is a small software program that is designed to add functionality to the Google Chrome web browser. Extensions can be developed using web technologies such as HTML, CSS, and JavaScript. Therefore, JavaScript is often used in the development of Chrome extensions to add interactivity and to implement the logic of the extension."><meta name=application-name content="JerrysBlog"><meta name=apple-mobile-web-app-title content="JerrysBlog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=https://cdn-icons-png.flaticon.com/128/5584/5584593.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://jerrysmd.github.io/20220929_chrome-extension-project/><link rel=prev href=https://jerrysmd.github.io/20220914_springmvc-intro/><link rel=next href=https://jerrysmd.github.io/20221114_stock-spy/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://unpkg.com/@fortawesome/fontawesome-free@6.2.0/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/@fortawesome/fontawesome-free@6.2.0/css/all.min.css></noscript><link rel=preload href=https://unpkg.com/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Chrome Extension Project: Weibo Advertising Filter","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/jerrysmd.github.io\/20220929_chrome-extension-project\/"},"genre":"posts","keywords":"JavaScript, Browser Extension","wordcount":1091,"url":"https:\/\/jerrysmd.github.io\/20220929_chrome-extension-project\/","datePublished":"2022-09-29T12:05:56+08:00","dateModified":"2022-09-29T12:05:56+08:00","publisher":{"@type":"Organization","name":"xxxx","logo":"https:\/\/jerrysmd.github.io\/images\/avatar.png"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=JerrysBlog><span class=header-title-pre><i class='far fa-edit fa-fw' aria-hidden=true></i></span>JERRYSBLOG</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/ title=Home>Home </a><a class=menu-item href=/categories/technology/ title="Technology article list">Technology </a><a class=menu-item href=/categories/life/ title="Life article list">Life </a><a class=menu-item href=/tags/ title="Tags cloud">Tags </a><a class=menu-item href=/about/ title="About blog">About </a><a class=menu-item href=https://github.com/Jerrysmd title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-moon fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=JerrysBlog><span class=header-title-pre><i class='far fa-edit fa-fw' aria-hidden=true></i></span>JERRYSBLOG</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/ title=Home>Home</a><a class=menu-item href=/categories/technology/ title="Technology article list">Technology</a><a class=menu-item href=/categories/life/ title="Life article list">Life</a><a class=menu-item href=/tags/ title="Tags cloud">Tags</a><a class=menu-item href=/about/ title="About blog">About</a><a class=menu-item href=https://github.com/Jerrysmd title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-moon fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Chrome Extension Project: Weibo Advertising Filter</h1><div class=post-meta><div class=post-meta-line><span class=post-category>Category
<a href=/categories/technology/><i class="far fa-folder fa-fw" aria-hidden=true></i>Technology</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-09-29>2022-09-29</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1091 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;6 minutes&nbsp;<span id=/20220929_chrome-extension-project/ class=leancloud_visitors data-flag-title="Chrome Extension Project: Weibo Advertising Filter">
<i class="far fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;views
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#requirements-analysis>Requirements analysis</a></li><li><a href=#design>Design</a></li><li><a href=#implementation>Implementation</a></li><li><a href=#testing>Testing</a></li><li><a href=#deployment>Deployment</a></li></ul></nav></div></div><div class=content id=content><p>A Chrome extension is a small software program that is designed to add functionality to the Google Chrome web browser. Extensions can be developed using web technologies such as HTML, CSS, and JavaScript. Therefore, JavaScript is often used in the development of Chrome extensions to add interactivity and to implement the logic of the extension.</p><h2 id=introduction>Introduction</h2><blockquote><p><strong>Github Project</strong></p><p><a href=https://github.com/Jerrysmd/weibo-content-filter target=_blank rel="noopener noreffer">https://github.com/Jerrysmd/weibo-content-filter</a></p></blockquote><p>This is a Chrome extension that serves as a new version of the Weibo plugin.</p><p>It removes recommended, promoted, and advertisement Weibo from the timeline.</p><p>With this extension, users can enjoy a cleaner and more streamlined Weibo experience.</p><p>The extension is designed to improve the user&rsquo;s browsing experience by removing unnecessary content and focusing on the content that the user wants to see.</p><p>It is a simple and easy-to-use tool that can greatly enhance the way users interact with Weibo.</p><h2 id=requirements-analysis>Requirements analysis</h2><p>In order to develop a Chrome extension that effectively removes recommended, promoted, and advertisement Weibo from the timeline, we conducted a thorough requirements analysis to identify the needs and expectations of the target audience.</p><p>This included gathering feedback from potential users, researching similar extensions on the market, and analyzing the technical requirements for implementing the desired functionality.</p><p>Based on this analysis, we identified the following functional requirements for the extension:</p><ul><li>The extension should be able to identify and remove recommended, promoted, and advertisement Weibo from the timeline.</li><li>The extension should allow the user to customize which types of Weibo they want to remove (e.g. recommended only, promoted only, both recommended and promoted).</li><li>The extension should have a user-friendly interface that allows the user to easily enable or disable the extension.</li></ul><p>In addition to these functional requirements, we also identified the following non-functional requirements:</p><ul><li>The extension should be lightweight and not significantly impact the performance of the browser.</li><li>The extension should be compatible with the latest version of Google Chrome.</li><li>The extension should be easy to install and use for the average user.</li></ul><p>By considering these requirements, we were able to create a clear vision for the extension and develop a plan for its development.</p><h2 id=design>Design</h2><p>In order to meet the requirements and deliver a high-quality Chrome extension, we have developed the following design for the extension:</p><ol><li>User interface: The extension will have a simple and intuitive user interface that allows the user to easily enable or disable the extension, as well as customize the types of Weibo that they want to remove. The interface will consist of a toggle button and a drop-down menu, both of which can be accessed from the extension icon in the Chrome toolbar.</li><li>Weibo identification: To identify recommended, promoted, and advertisement Weibo, the extension will use a combination of CSS selectors and JavaScript code. The selectors will be used to locate the relevant elements on the page, and the JavaScript code will be used to determine whether the elements should be removed based on the user&rsquo;s preferences.</li><li>Performance optimization: To ensure that the extension does not significantly impact the performance of the browser, we will optimize the code for efficiency and minimize the number of DOM manipulations. We will also implement caching and other performance-enhancing techniques as necessary.</li></ol><p>Overall, our design aims to create a simple and effective tool that improves the user&rsquo;s experience on Weibo by removing unwanted content from the timeline.</p><h2 id=implementation>Implementation</h2><p>manifest.json：Chrome extension settings</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;大眼夹（新版微博）&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;short_name&#34;</span><span class=p>:</span> <span class=s2>&#34;大眼夹&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;manifest_version&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;新版微博非官方插件，去除时间线上的推荐、推广和广告微博。&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;icons&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nt>&#34;48&#34;</span><span class=p>:</span> <span class=s2>&#34;weiboFilter.png&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nt>&#34;128&#34;</span><span class=p>:</span> <span class=s2>&#34;weiboFilter.large.png&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;content_scripts&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nt>&#34;matches&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>				<span class=s2>&#34;https://weibo.com/*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s2>&#34;https://www.weibo.com/*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s2>&#34;https://d.weibo.com/*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s2>&#34;http://d.weibo.com/*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s2>&#34;http://weibo.com/*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s2>&#34;http://www.weibo.com/*&#34;</span>
</span></span><span class=line><span class=cl>			<span class=p>],</span>
</span></span><span class=line><span class=cl>			<span class=nt>&#34;js&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;main.js&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>			<span class=nt>&#34;run_at&#34;</span><span class=p>:</span> <span class=s2>&#34;document_end&#34;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>],</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;web_accessible_resources&#34;</span><span class=p>:</span> <span class=p>[{</span>
</span></span><span class=line><span class=cl>		<span class=nt>&#34;resources&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;weiboClean.js&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>		<span class=nt>&#34;matches&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;&lt;all_urls&gt;&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=p>}],</span>	
</span></span><span class=line><span class=cl>	<span class=nt>&#34;permissions&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>		<span class=s2>&#34;storage&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>main.js</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// 借助自定义事件实现page script（注入页面的主程序）与content script（运行在沙箱中）
</span></span></span><span class=line><span class=cl><span class=c1>//   之间的异步通讯，使前者可以间接调用chrome.* API和GM_* API
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;I am in weiboFilter.js&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;wbpGet&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>event</span><span class=p>.</span><span class=nx>stopPropagation</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>detail</span><span class=p>.</span><span class=nx>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>post</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 注意：不能在此处直接调用callback，否则回调函数将在本程序所在的沙箱环境中运行，在Chrome 27及更高版本下会出错
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// 在Greasemonkey（Firefox扩展）环境下也不能通过detail直接传对象，只能送string或array
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// 详见https://developer.mozilla.org/en-US/docs/Web/API/CustomEvent#Specification
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nb>document</span><span class=p>.</span><span class=nx>dispatchEvent</span><span class=p>(</span><span class=k>new</span> <span class=nx>CustomEvent</span><span class=p>(</span><span class=s1>&#39;wbpPost&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>detail</span><span class=o>:</span> <span class=nx>event</span><span class=p>.</span><span class=nx>detail</span><span class=p>.</span><span class=nx>id</span> <span class=o>+</span> <span class=s1>&#39;=&#39;</span> <span class=o>+</span> <span class=p>(</span><span class=nx>value</span> <span class=o>||</span> <span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=p>}));</span>
</span></span><span class=line><span class=cl>	<span class=p>};</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>detail</span><span class=p>.</span><span class=nx>sync</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 一次性读取所有设置
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>chrome</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nx>sync</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>items</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kd>var</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>value</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>while</span> <span class=p>((</span><span class=nx>name</span> <span class=o>+</span> <span class=s1>&#39;_&#39;</span> <span class=o>+</span> <span class=nx>i</span><span class=p>)</span> <span class=k>in</span> <span class=nx>items</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>value</span> <span class=o>+=</span> <span class=nx>items</span><span class=p>[</span><span class=nx>name</span> <span class=o>+</span> <span class=s1>&#39;_&#39;</span> <span class=o>+</span> <span class=p>(</span><span class=nx>i</span><span class=o>++</span><span class=p>)];</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>post</span><span class=p>(</span><span class=nx>i</span> <span class=o>?</span> <span class=nx>value</span> <span class=o>:</span> <span class=nx>event</span><span class=p>.</span><span class=nx>detail</span><span class=p>.</span><span class=nx>defVal</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>});</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 注意：使用chrome.storage.StorageArea.get()时，如果通过{name:defVal}的形式传送默认值，
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>//   且defVal为null或undefined，即使name存在也会返回空对象{}，详见crbug.com/145081
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>chrome</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nx>local</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>items</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>post</span><span class=p>(</span><span class=nx>name</span> <span class=k>in</span> <span class=nx>items</span> <span class=o>?</span> <span class=nx>items</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>:</span> <span class=nx>event</span><span class=p>.</span><span class=nx>detail</span><span class=p>.</span><span class=nx>defVal</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>});</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;wbpSet&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>event</span><span class=p>.</span><span class=nx>stopPropagation</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>data</span> <span class=o>=</span> <span class=p>{},</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>detail</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=nx>value</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>detail</span><span class=p>.</span><span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>data</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>=</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>detail</span><span class=p>.</span><span class=nx>sync</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// 将设置保存到同步存储
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// 一次性读取所有设置
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>chrome</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nx>sync</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>items</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kd>var</span> <span class=nx>data</span> <span class=o>=</span> <span class=p>{},</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>errorHandler</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=nx>chrome</span><span class=p>.</span><span class=nx>runtime</span> <span class=o>&amp;&amp;</span> <span class=nx>chrome</span><span class=p>.</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>lastError</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;Error writing to storage.sync: &#39;</span> <span class=o>+</span> <span class=nx>chrome</span><span class=p>.</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>lastError</span><span class=p>.</span><span class=nx>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span> <span class=nx>partLength</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>round</span><span class=p>(</span><span class=nx>chrome</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nx>sync</span><span class=p>.</span><span class=nx>QUOTA_BYTES_PER_ITEM</span> <span class=o>*</span> <span class=mf>0.8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=c1>// chrome.storage.sync的存储条数（MAX_ITEMS=512）与单条长度（QUOTA_BYTES_PER_ITEM=4,096）
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// 均受限制，当设置过长时需要拆分；chrome.storage.storageArea.set()会对输入项
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// 做一次JSON.stringify()，且Unicode字符将被转换为\uXXXX的转义形式，都会导致字符串膨胀
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// 因此拆分时需要事先留出一定裕度（此处保留20%），并将字符串转为Unicode转义格式
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>s</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nx>u</span><span class=p>;</span> <span class=nx>j</span> <span class=o>&lt;</span> <span class=nx>value</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=o>++</span><span class=nx>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=nx>value</span><span class=p>.</span><span class=nx>charCodeAt</span><span class=p>(</span><span class=nx>j</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mh>0x80</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// ASCII字符
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>s</span> <span class=o>+=</span> <span class=nx>value</span><span class=p>.</span><span class=nx>charAt</span><span class=p>(</span><span class=nx>j</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=o>++</span><span class=nx>l</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span> <span class=c1>// Unicode字符
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>u</span> <span class=o>=</span> <span class=nx>value</span><span class=p>.</span><span class=nx>charCodeAt</span><span class=p>(</span><span class=nx>j</span><span class=p>).</span><span class=nx>toString</span><span class=p>(</span><span class=mi>16</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=nx>s</span> <span class=o>+=</span> <span class=s1>&#39;\\u&#39;</span> <span class=o>+</span> <span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>2</span> <span class=o>?</span> <span class=s1>&#39;00&#39;</span> <span class=o>+</span> <span class=nx>u</span> <span class=o>:</span> <span class=nx>u</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>3</span> <span class=o>?</span> <span class=s1>&#39;0&#39;</span> <span class=o>+</span> <span class=nx>u</span> <span class=o>:</span> <span class=nx>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>					<span class=nx>l</span> <span class=o>+=</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=nx>l</span> <span class=o>&gt;=</span> <span class=nx>partLength</span><span class=p>)</span> <span class=p>{</span> <span class=nx>data</span><span class=p>[</span><span class=nx>name</span> <span class=o>+</span> <span class=s1>&#39;_&#39;</span> <span class=o>+</span> <span class=p>(</span><span class=nx>i</span><span class=o>++</span><span class=p>)]</span> <span class=o>=</span> <span class=nx>s</span><span class=p>;</span> <span class=nx>l</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>s</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=nx>l</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span> <span class=nx>data</span><span class=p>[</span><span class=nx>name</span> <span class=o>+</span> <span class=s1>&#39;_&#39;</span> <span class=o>+</span> <span class=p>(</span><span class=nx>i</span><span class=o>++</span><span class=p>)]</span> <span class=o>=</span> <span class=nx>s</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 保存新的设置
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>chrome</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nx>sync</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nx>errorHandler</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 清除多余的旧设置块
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=kd>var</span> <span class=nx>keys</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>			<span class=k>while</span> <span class=p>((</span><span class=nx>name</span> <span class=o>+</span> <span class=s1>&#39;_&#39;</span> <span class=o>+</span> <span class=nx>i</span><span class=p>)</span> <span class=k>in</span> <span class=nx>items</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>keys</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>name</span> <span class=o>+</span> <span class=s1>&#39;_&#39;</span> <span class=o>+</span> <span class=p>(</span><span class=nx>i</span><span class=o>++</span><span class=p>));</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>chrome</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nx>sync</span><span class=p>.</span><span class=nx>remove</span><span class=p>(</span><span class=nx>keys</span><span class=p>,</span> <span class=nx>errorHandler</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>});</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span> <span class=c1>// 将设置保存到本地存储
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>chrome</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nx>local</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=c1>//#endif
</span></span></span><span class=line><span class=cl><span class=c1>// 将脚本注入页面环境
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>script</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;script&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>script</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s1>&#39;type&#39;</span><span class=p>,</span> <span class=s1>&#39;text/javascript&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>script</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=nx>chrome</span><span class=p>.</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>getURL</span><span class=p>(</span><span class=s2>&#34;/weiboClean.js&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>head</span><span class=p>.</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>script</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>weiboClean.js</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>&#39;DOMNodeInserted&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>node</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>target</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>tagName</span> <span class=o>!==</span> <span class=s1>&#39;DIV&#39;</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nb>document</span><span class=p>.</span><span class=nx>querySelectorAll</span><span class=p>(</span><span class=s1>&#39;#scroller &gt; div.vue-recycle-scroller__item-wrapper &gt; div&#39;</span><span class=p>).</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>div</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//console.log(div);
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span><span class=p>(</span><span class=nx>div</span><span class=p>.</span><span class=nx>querySelectorAll</span><span class=p>(</span><span class=s1>&#39;i[title=&#34;负反馈&#34;&#39;</span><span class=p>).</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=nx>div</span><span class=p>.</span><span class=nx>style</span><span class=p>.</span><span class=nx>display</span> <span class=o>=</span> <span class=s1>&#39;none&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>div</span><span class=p>.</span><span class=nx>style</span><span class=p>.</span><span class=nx>display</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=testing>Testing</h2><p>Detecting the GUCCI advertising，add the attribute of <code>display: none</code></p><p><figure><a class=lightgallery href=/20220929_chrome-extension-project/image-20221219135815955.png title=image-20221219135815955 data-thumbnail=/20220929_chrome-extension-project/image-20221219135815955.png data-sub-html="<h2>Test</h2><p>image-20221219135815955</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/20220929_chrome-extension-project/image-20221219135815955.png data-srcset="/20220929_chrome-extension-project/image-20221219135815955.png, /20220929_chrome-extension-project/image-20221219135815955.png 1.5x, /20220929_chrome-extension-project/image-20221219135815955.png 2x" data-sizes=auto alt=/20220929_chrome-extension-project/image-20221219135815955.png width=1920 height=959></a><figcaption class=image-caption>Test</figcaption></figure></p><h2 id=deployment>Deployment</h2><p><figure><a class=lightgallery href=/20220929_chrome-extension-project/image-20221219140615001.png title=image-20221219140615001 data-thumbnail=/20220929_chrome-extension-project/image-20221219140615001.png data-sub-html="<h2>Deployment</h2><p>image-20221219140615001</p>"><img class=lazyload src=/svg/loading.min.svg data-src=/20220929_chrome-extension-project/image-20221219140615001.png data-srcset="/20220929_chrome-extension-project/image-20221219140615001.png, /20220929_chrome-extension-project/image-20221219140615001.png 1.5x, /20220929_chrome-extension-project/image-20221219140615001.png 2x" data-sizes=auto alt=/20220929_chrome-extension-project/image-20221219140615001.png width=758 height=353></a><figcaption class=image-caption>Deployment</figcaption></figure></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/javascript/>JavaScript</a>,&nbsp;<a href=/tags/browser-extension/>Browser Extension</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/20220914_springmvc-intro/ class=prev rel=prev title="SpringMVC Introduction"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>SpringMVC Introduction</a>
<a href=/20221114_stock-spy/ class=next rel=next title="Stock Monitoring and Notification Project">Stock Monitoring and Notification Project<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2018 - 2023</span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=https://unpkg.com/lightgallery@2.6.1/css/lightgallery-bundle.min.css><script type=text/javascript src=https://unpkg.com/valine@1.5.1/dist/Valine.min.js></script><script type=text/javascript src=https://unpkg.com/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://unpkg.com/algoliasearch@4.14.2/dist/algoliasearch-lite.umd.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=https://unpkg.com/lightgallery@2.6.1/lightgallery.min.js></script><script type=text/javascript src=https://unpkg.com/lightgallery@2.6.1/plugins/thumbnail/lg-thumbnail.min.js></script><script type=text/javascript src=https://unpkg.com/lightgallery@2.6.1/plugins/zoom/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:40},comment:{valine:{appId:"2jSYKh8PFUje3v7Ie3Nn5v1g-gzGzoHsz",appKey:"MyWn4P9G5N32q3oM5JDnlpdL",avatar:"retro",el:"#valine",emojiCDN:"https://img.t.sinajs.cn/t4/appstyle/expression/ext/normal/",enableQQ:!0,highlight:!0,lang:"en",meta:["nick","mail"],pageSize:10,placeholder:"Your comment ...",recordIP:!0,visitor:!0}},lightgallery:!0,search:{algoliaAppID:"BADKNNRXHD",algoliaIndex:"index",algoliaSearchKey:"7a8c2923330a44bdd9985698e3f28e0c",highlightTag:"em",maxResultLength:8,noResultsFound:"No results found",snippetLength:40,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>